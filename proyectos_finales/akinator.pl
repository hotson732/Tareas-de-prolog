:- use_module(library(readutil)).


pokemon(pikachu, [
    tipo(electrico),
    color(amarillo),
    generacion(1),
    evoluciones(raichu),
    habitat(bosque),
    tamaño(pequeño),
    forma(cuadrúpedo),
    legendario(no),
    mitico(no)
]).

pokemon(charizard, [
    tipo(fuego, volador),
    color(naranja),
    generacion(1),
    evoluciones(ninguna),
    habitat(montaña),
    tamaño(grande),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(bulbasaur, [
    tipo(planta, veneno),
    color(verde),
    generacion(1),
    evoluciones(ivysaur, venusaur),
    habitat(pradera),
    tamaño(pequeño),
    forma(cuadrúpedo),
    legendario(no),
    mitico(no)
]).

pokemon(squirtle, [
    tipo(agua),
    color(azul),
    generacion(1),
    evoluciones(wartortle, blastoise),
    habitat(agua_dulce),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(eevee, [
    tipo(normal),
    color(marrón),
    generacion(1),
    evoluciones(muchas),
    habitat(ciudad),
    tamaño(pequeño),
    forma(cuadrúpedo),
    legendario(no),
    mitico(no)
]).

pokemon(mewtwo, [
    tipo(psiquico),
    color(blanco),
    generacion(1),
    evoluciones(mew),
    habitat(laboratorio),
    tamaño(mediano),
    forma(bípedo),
    legendario(si),
    mitico(no)
]).

pokemon(mew, [
    tipo(psiquico),
    color(rosa),
    generacion(1),
    evoluciones(ninguna),
    habitat(desconocido),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(si)
]).

pokemon(gyarados, [
    tipo(agua, volador),
    color(azul),
    generacion(1),
    evoluciones(ninguna),
    habitat(mar),
    tamaño(grande),
    forma(serpiente),
    legendario(no),
    mitico(no)
]).

pokemon(gengar, [
    tipo(fantasma, veneno),
    color(morado),
    generacion(1),
    evoluciones(ninguna),
    habitat(nocturno),
    tamaño(mediano),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(dragonite, [
    tipo(dragon, volador),
    color(naranja),
    generacion(1),
    evoluciones(ninguna),
    habitat(mar),
    tamaño(grande),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(lugia, [
    tipo(psiquico, volador),
    color(blanco),
    generacion(2),
    evoluciones(ninguna),
    habitat(mar),
    tamaño(grande),
    forma(bípedo),
    legendario(si),
    mitico(no)
]).

pokemon(ho_oh, [
    tipo(fuego, volador),
    color(rojo),
    generacion(2),
    evoluciones(ninguna),
    habitat(cielo),
    tamaño(grande),
    forma(ave),
    legendario(si),
    mitico(no)
]).

pokemon(celebi, [
    tipo(psiquico, planta),
    color(verde),
    generacion(2),
    evoluciones(ninguna),
    habitat(bosque),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(si)
]).

pokemon(blaziken, [
    tipo(fuego, lucha),
    color(rojo),
    generacion(3),
    evoluciones(ninguna),
    habitat(montaña),
    tamaño(grande),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(rayquaza, [
    tipo(dragon, volador),
    color(verde),
    generacion(3),
    evoluciones(ninguna),
    habitat(cielo),
    tamaño(grande),
    forma(serpiente),
    legendario(si),
    mitico(no)
]).

pokemon(lucario, [
    tipo(lucha, acero),
    color(azul),
    generacion(4),
    evoluciones(ninguna),
    habitat(montaña),
    tamaño(mediano),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(garchomp, [
    tipo(dragon, tierra),
    color(azul),
    generacion(4),
    evoluciones(ninguna),
    habitat(desierto),
    tamaño(grande),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(darkrai, [
    tipo(siniestro),
    color(negro),
    generacion(4),
    evoluciones(ninguna),
    habitat(nocturno),
    tamaño(mediano),
    forma(bípedo),
    legendario(no),
    mitico(si)
]).

pokemon(zekrom, [
    tipo(dragon, electrico),
    color(negro),
    generacion(5),
    evoluciones(ninguna),
    habitat(desconocido),
    tamaño(grande),
    forma(bípedo),
    legendario(si),
    mitico(no)
]).

pokemon(greninja, [
    tipo(agua, siniestro),
    color(azul),
    generacion(6),
    evoluciones(ninguna),
    habitat(bosque),
    tamaño(mediano),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(xerneas, [
    tipo(hada),
    color(azul),
    generacion(6),
    evoluciones(ninguna),
    habitat(bosque),
    tamaño(grande),
    forma(cuadrúpedo),
    legendario(si),
    mitico(no)
]).

pokemon(incineroar, [
    tipo(fuego, siniestro),
    color(rojo),
    generacion(7),
    evoluciones(ninguna),
    habitat(ciudad),
    tamaño(grande),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(solgaleo, [
    tipo(psiquico, acero),
    color(blanco),
    generacion(7),
    evoluciones(ninguna),
    habitat(espacio),
    tamaño(grande),
    forma(león),
    legendario(si),
    mitico(no)
]).

pokemon(jigglypuff, [
    tipo(normal, hada),
    color(rosa),
    generacion(1),
    evoluciones(wigglytuff),
    habitat(pradera),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(snorlax, [
    tipo(normal),
    color(negro),
    generacion(1),
    evoluciones(ninguna),
    habitat(bosque),
    tamaño(grande),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(articuno, [
    tipo(hielo, volador),
    color(azul),
    generacion(1),
    evoluciones(ninguna),
    habitat(montaña),
    tamaño(mediano),
    forma(ave),
    legendario(si),
    mitico(no)
]).

pokemon(zapdos, [
    tipo(electrico, volador),
    color(amarillo),
    generacion(1),
    evoluciones(ninguna),
    habitat(montaña),
    tamaño(mediano),
    forma(ave),
    legendario(si),
    mitico(no)
]).

pokemon(moltres, [
    tipo(fuego, volador),
    color(rojo),
    generacion(1),
    evoluciones(ninguna),
    habitat(montaña),
    tamaño(mediano),
    forma(ave),
    legendario(si),
    mitico(no)
]).

pokemon(chikorita, [
    tipo(planta),
    color(verde),
    generacion(2),
    evoluciones(bayleef, meganium),
    habitat(pradera),
    tamaño(pequeño),
    forma(cuadrúpedo),
    legendario(no),
    mitico(no)
]).

pokemon(cyndaquil, [
    tipo(fuego),
    color(amarillo),
    generacion(2),
    evoluciones(quilava, typhlosion),
    habitat(pradera),
    tamaño(pequeño),
    forma(cuadrúpedo),
    legendario(no),
    mitico(no)
]).

pokemon(totodile, [
    tipo(agua),
    color(azul),
    generacion(2),
    evoluciones(croconaw, feraligatr),
    habitat(agua_dulce),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(togepi, [
    tipo(hada),
    color(blanco),
    generacion(2),
    evoluciones(togetic, togekiss),
    habitat(pradera),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(umbreon, [
    tipo(siniestro),
    color(negro),
    generacion(2),
    evoluciones(ninguna),
    habitat(nocturno),
    tamaño(mediano),
    forma(cuadrúpedo),
    legendario(no),
    mitico(no)
]).

pokemon(treecko, [
    tipo(planta),
    color(verde),
    generacion(3),
    evoluciones(grovyle, sceptile),
    habitat(bosque),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(mudkip, [
    tipo(agua),
    color(azul),
    generacion(3),
    evoluciones(marshtomp, swampert),
    habitat(agua_dulce),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(jirachi, [
    tipo(acero, psiquico),
    color(amarillo),
    generacion(3),
    evoluciones(ninguna),
    habitat(espacio),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(si)
]).

pokemon(deoxys, [
    tipo(psiquico),
    color(rojo),
    generacion(3),
    evoluciones(ninguna),
    habitat(espacio),
    tamaño(mediano),
    forma(bípedo),
    legendario(no),
    mitico(si)
]).

pokemon(infernape, [
    tipo(fuego, lucha),
    color(marrón),
    generacion(4),
    evoluciones(ninguna),
    habitat(montaña),
    tamaño(mediano),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pokemon(arceus, [
    tipo(normal),
    color(blanco),
    generacion(4),
    evoluciones(ninguna),
    habitat(desconocido),
    tamaño(mediano),
    forma(cuadrúpedo),
    legendario(no),
    mitico(si)
]).

pokemon(victini, [
    tipo(psiquico, fuego),
    color(blanco),
    generacion(5),
    evoluciones(ninguna),
    habitat(desconocido),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(si)
]).

pokemon(meloetta, [
    tipo(normal, psiquico),
    color(blanco),
    generacion(5),
    evoluciones(ninguna),
    habitat(desconocido),
    tamaño(pequeño),
    forma(bípedo),
    legendario(no),
    mitico(si)
]).

pokemon(decidueye, [
    tipo(planta, fantasma),
    color(verde),
    generacion(7),
    evoluciones(ninguna),
    habitat(bosque),
    tamaño(mediano),
    forma(bípedo),
    legendario(no),
    mitico(no)
]).

pregunta(tipo(Tipo), '¿Es de tipo ~w?', [Tipo]).
pregunta(color(Color), '¿Es de color ~w?', [Color]).
pregunta(generacion(Gen), '¿Es de la generación ~w?', [Gen]).
pregunta(evoluciones(Evol), '¿Tiene evoluciones? (~w)', [Evol]).
pregunta(habitat(Habitat), '¿Vive en ~w?', [Habitat]).
pregunta(tamaño(Tam), '¿Es de tamaño ~w?', [Tam]).
pregunta(forma(Forma), '¿Tiene forma ~w?', [Forma]).
pregunta(legendario(Leg), '¿Es legendario? (~w)', [Leg]).
pregunta(mitico(Mit), '¿Es mítico? (~w)', [Mit]).

caracteristicas_disponibles([
    tipo(electrico), tipo(fuego), tipo(agua), tipo(planta), tipo(normal),
    tipo(psiquico), tipo(lucha), tipo(volador), tipo(veneno), tipo(tierra),
    tipo(roca), tipo(bicho), tipo(fantasma), tipo(acero), tipo(hielo),
    tipo(dragon), tipo(siniestro), tipo(hada),
    
    color(amarillo), color(naranja), color(rojo), color(verde), color(azul),
    color(morado), color(rosa), color(marrón), color(negro), color(blanco),
    
    generacion(1), generacion(2), generacion(3), generacion(4),
    generacion(5), generacion(6), generacion(7),
    
    evoluciones(ninguna), evoluciones(muchas),
    evoluciones(raichu), evoluciones(ivysaur), evoluciones(venusaur),
    evoluciones(wartortle), evoluciones(blastoise), evoluciones(mew),
    
    habitat(bosque), habitat(montaña), habitat(pradera), habitat(agua_dulce),
    habitat(mar), habitat(ciudad), habitat(desierto), habitat(nocturno),
    habitat(cielo), habitat(espacio), habitat(laboratorio), habitat(desconocido),
    
    tamaño(pequeño), tamaño(mediano), tamaño(grande),
    
    forma(cuadrúpedo), forma(bípedo), forma(serpiente), forma(ave), forma(león),
    
    legendario(si), legendario(no),
    mitico(si), mitico(no)
]).

jugar :-
    writeln('¡Bienvenido al adivinador Pokemon!'),
    writeln('Piensa en un Pokemon e intentare adivinarlo.'),
    writeln('Responde con "si", "no", o "ns" (no sé).'),
    nl,
    adivinar_pokemon([]).

% Adivinar Pokémon con características conocidas
adivinar_pokemon(CaracteristicasConocidas) :-
    findall(P, pokemon_cumple(P, CaracteristicasConocidas), Posibles),
    adivinar_con_lista(Posibles, CaracteristicasConocidas).

pokemon_cumple(Nombre, Caracteristicas) :-
    pokemon(Nombre, Atributos),
    forall(member(C, Caracteristicas), 
           (C = not(Pregunta) -> \+ member(Pregunta, Atributos)
           ; member(C, Atributos))).

adivinar_con_lista([Unico], _) :-
    !,
    format('¿Tu Pokémon es ~w? ', [Unico]),
    leer_respuesta(Respuesta),
    manejar_respuesta_final(Respuesta, Unico).

adivinar_con_lista([], Caracteristicas) :-
    !,
    writeln('No conozco ningún Pokémon con esas características.'),
    writeln('¿Quieres añadirlo? (si/no)'),
    leer_respuesta(Respuesta),
    (Respuesta = si -> aprender_pokemon(Caracteristicas); true).

adivinar_con_lista(Posibles, CaracteristicasConocidas) :-
    encontrar_pregunta(Posibles, CaracteristicasConocidas, Pregunta),
    hacer_pregunta(Pregunta, Respuesta),
    (Respuesta = si ->
        adivinar_pokemon([Pregunta|CaracteristicasConocidas])
    ; Respuesta = no ->
        adivinar_pokemon([not(Pregunta)|CaracteristicasConocidas])
    ; adivinar_pokemon(CaracteristicasConocidas) % Para ns (no sé)
    ).

encontrar_pregunta(Posibles, Conocidas, MejorPregunta) :-
    caracteristicas_disponibles(Todas),
    exclude(es_conocida(Conocidas), Todas, PreguntasPosibles),
    calcular_mejor_pregunta(Posibles, PreguntasPosibles, MejorPregunta).

es_conocida(Conocidas, Pregunta) :-
    member(Pregunta, Conocidas).
es_conocida(Conocidas, Pregunta) :-
    member(not(Pregunta), Conocidas).

calcular_mejor_pregunta(Posibles, Preguntas, MejorPregunta) :-
    maplist(calcular_valor_pregunta(Posibles), Preguntas, Valores),
    max_member(_-MejorPregunta, Valores).

calcular_valor_pregunta(Posibles, Pregunta, Valor-Pregunta) :-
    partition(pokemon_tiene(Pregunta), Posibles, Si, No),
    length(Si, LSi),
    length(No, LNo),
    Valor is -abs(LSi - LNo).

pokemon_tiene(Pregunta, Pokemon) :-
    pokemon(Pokemon, Atributos),
    member(Pregunta, Atributos).

hacer_pregunta(Pregunta, Respuesta) :-
    pregunta(Pregunta, Texto, Args),
    format(Texto, Args),
    leer_respuesta(Respuesta).

manejar_respuesta_final(si, _) :-
    !,  
    writeln('funciona').

manejar_respuesta_final(no, _) :-
    writeln('no hagas trampa.'),
    writeln('¿Quieres enseñarme tu Pokémon? (si/no)'),
    leer_respuesta(Respuesta),
    (Respuesta = si -> aprender_pokemon([]); true).

aprender_pokemon(CaracteristicasConocidas) :-
    writeln('Aun no se como hacer esto vuelve el siguiente semestre en ia'),
    writeln(' .'),    read_line_to_string(user_input, EntradaStr).

leer_respuesta(Respuesta) :-
    read_line_to_string(user_input, EntradaStr),
    string_lower(EntradaStr, EntradaLower),
    atom_string(EntradaAtom, EntradaLower),
    ( EntradaAtom = si -> Respuesta = si
    ; EntradaAtom = no -> Respuesta = no
    ; EntradaAtom = ns -> Respuesta = ns
    ; writeln('Respuesta no válida. Usa si/no/ns'),
      leer_respuesta(Respuesta)
    ).

mostrar_pokemon :-
    findall(N, pokemon(N, _), Pokemons),
    writeln('Pokémon que conozco:'),
    forall(member(P, Pokemons), writeln(P)).

reiniciar :-
    retractall(pokemon(_, _)),
    consult('akineitor_pokemon.pl'), 
    writeln('Base de conocimientos reiniciada.').

:- writeln('Para jugar, escribe "jugar."'),
   writeln('Para ver todos los Pokémon, escribe "mostrar_pokemon."').
